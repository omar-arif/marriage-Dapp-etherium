<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marriage DApp</title>
  <link rel="icon" href="data:,">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg:        #f0f2f5;
      --surface:   #ffffff;
      --border:    #eeeeee;
      --text:      #222222;
      --muted:     #888888;
      --primary:   #7c4dff;
      --green:     #4caf50;
      --blue:      #2196f3;
      --orange:    #f6851b;
      --red:       #e53935;
      --yellow:    #ffc107;
      --ok-bg:     #e8f5e9;
      --ok-text:   #2e7d32;
      --err-bg:    #ffebee;
      --err-text:  #c62828;
      --step-bg:   #f5f5f5;
      --step-text: #999999;
    }
    [data-theme="dark"] {
      --bg:        #0f1117;
      --surface:   #1a1d27;
      --border:    #2a2d3a;
      --text:      #e8eaf6;
      --muted:     #7986cb;
      --primary:   #9c6dff;
      --green:     #66bb6a;
      --blue:      #42a5f5;
      --orange:    #ffa726;
      --red:       #ef5350;
      --yellow:    #ffca28;
      --ok-bg:     #1b3a1f;
      --ok-text:   #a5d6a7;
      --err-bg:    #3e1a1a;
      --err-text:  #ef9a9a;
      --step-bg:   #1e2130;
      --step-text: #7986cb;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text);
      padding: 24px; transition: background 0.3s, color 0.3s;
    }
    h1 { text-align: center; font-size: 2rem; margin-bottom: 4px; }
    .subtitle { text-align: center; color: var(--muted); margin-bottom: 32px; font-size: 14px; }
    .container { max-width: 780px; margin: 0 auto; }
    .card {
      background: var(--surface); border-radius: 14px; padding: 24px;
      margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
    }
    .card h2 { font-size: 1.05rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    #connect-screen {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 65vh; gap: 14px;
    }
    #connect-screen h2 { font-size: 1.5rem; }
    #connect-screen p  { color: var(--muted); font-size: 14px; text-align: center; max-width: 380px; }
    #top-bar {
      background: var(--surface); border-radius: 14px; padding: 12px 20px;
      margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
      display: none; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
    }
    .account-info { display: flex; align-items: center; gap: 10px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
    .address { font-size: 13px; color: var(--muted); word-break: break-all; }
    .top-bar-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .network-badge {
      background: var(--ok-bg); color: var(--ok-text);
      font-size: 12px; padding: 4px 10px; border-radius: 20px; font-weight: 600;
    }
    label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; color: var(--muted); }
    input {
      display: block; width: 100%; padding: 10px 12px;
      border: 1.5px solid var(--border); border-radius: 9px;
      font-size: 14px; margin-bottom: 14px;
      background: var(--bg); color: var(--text); transition: border 0.2s;
    }
    input:focus { outline: none; border-color: var(--primary); }
    button {
      padding: 10px 20px; border: none; border-radius: 9px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }
    button:hover:not(:disabled) { opacity: 0.85; transform: translateY(-1px); }
    button:disabled { cursor: not-allowed; opacity: 0.45; transform: none; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-orange  { background: var(--orange);  color: #fff; }
    .btn-green   { background: var(--green);   color: #fff; }
    .btn-blue    { background: var(--blue);    color: #fff; }
    .btn-red     { background: var(--red);     color: #fff; }
    .btn-ghost   { background: transparent; color: var(--muted); border: 1.5px solid var(--border); }
    .btn-ghost:hover { border-color: var(--primary); color: var(--primary); }
    .btn-lg { padding: 14px 36px; font-size: 16px; }
    .btn-sm { padding: 6px 14px; font-size: 12px; }
    .status {
      margin-top: 12px; padding: 10px 14px; border-radius: 9px;
      font-size: 13px; display: none; line-height: 1.6;
    }
    .status.ok  { background: var(--ok-bg);  color: var(--ok-text);  display: block; }
    .status.err { background: var(--err-bg); color: var(--err-text); display: block; }
    .info-row {
      display: flex; justify-content: space-between; align-items: flex-start;
      padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 13px; gap: 12px;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--muted); flex-shrink: 0; }
    .info-value { font-weight: 600; text-align: right; word-break: break-all; }
    #nft-section { display: none; }
    .nft-inner { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
    .nft-img {
      width: 140px; height: 140px; object-fit: cover;
      border-radius: 12px; flex-shrink: 0; box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    }
    .nft-meta { flex: 1; min-width: 180px; }
    .nft-meta h3 { font-size: 1rem; margin-bottom: 10px; }
    .badge {
      display: inline-block; font-size: 11px; font-weight: 700;
      padding: 3px 10px; border-radius: 20px; margin-bottom: 8px; margin-right: 4px;
    }
    .badge-soul { background: #ede7f6; color: #6a1b9a; }
    .badge-ring { background: #fff3e0; color: #e65100; }
    .steps { display: flex; gap: 6px; margin-bottom: 20px; flex-wrap: wrap; }
    .step {
      flex: 1; min-width: 90px; text-align: center; padding: 10px 6px;
      border-radius: 9px; font-size: 11px; font-weight: 700;
      background: var(--step-bg); color: var(--step-text);
      border: 2px solid transparent; transition: all 0.3s;
    }
    .step.active  { background: #ede7f6; color: #6a1b9a; border-color: var(--primary); }
    .step.done    { background: var(--ok-bg); color: var(--ok-text); border-color: var(--green); }
    .step.waiting { background: #fff8e1; color: #f57f17; border-color: var(--yellow); }
    .countdown {
      font-size: 2.2rem; font-weight: 800; text-align: center;
      color: var(--primary); padding: 16px; letter-spacing: 3px;
      font-variant-numeric: tabular-nums;
    }
    .countdown.ready { color: var(--green); }
    .balance-display {
      font-size: 2.2rem; font-weight: 800;
      text-align: center; color: var(--primary); padding: 12px 0;
    }
    .hint { font-size: 12px; color: var(--muted); margin-top: -10px; margin-bottom: 12px; line-height: 1.5; }
    .hint a { color: var(--primary); text-decoration: none; font-weight: 600; }
    .danger-zone {
      border: 1.5px solid var(--red); border-radius: 14px; padding: 20px; margin-top: 8px;
    }
    .danger-zone h3 { color: var(--red); margin-bottom: 8px; font-size: 0.95rem; }
    .danger-zone p  { font-size: 13px; color: var(--muted); margin-bottom: 14px; line-height: 1.6; }
    .registry-filter { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .filter-btn {
      padding: 6px 16px; border-radius: 20px; border: 1.5px solid var(--border);
      background: transparent; color: var(--muted); font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .filter-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .marriage-item {
      padding: 14px; border-radius: 10px; background: var(--bg);
      margin-bottom: 10px; font-size: 13px; border: 1.5px solid var(--border);
      transition: border-color 0.2s;
    }
    .marriage-item:hover { border-color: var(--primary); }
    .marriage-item.mine  { border-color: var(--primary); background: var(--surface); }
    .marriage-item .names { font-weight: 700; margin-bottom: 6px; font-size: 14px; }
    .marriage-item .addr  { color: var(--muted); font-size: 11px; word-break: break-all; margin-bottom: 2px; }
    .mine-badge {
      display: inline-block; background: var(--primary); color: #fff;
      font-size: 10px; font-weight: 700; padding: 2px 8px;
      border-radius: 20px; margin-left: 8px; vertical-align: middle;
    }
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab {
      padding: 9px 18px; border-radius: 9px; border: 1.5px solid var(--border);
      background: var(--surface); color: var(--muted);
      font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .theme-toggle {
      background: var(--step-bg); border: 1.5px solid var(--border);
      border-radius: 20px; padding: 6px 12px;
      font-size: 14px; cursor: pointer; color: var(--text); transition: all 0.2s;
    }
    .theme-toggle:hover { border-color: var(--primary); }
    #app { display: none; }
    #dashboard-section { display: none; }
    #withdrawal-section { display: none; }
    @media (max-width: 520px) {
      .nft-inner { flex-direction: column; }
      .nft-img { width: 100%; height: auto; }
      .steps .step { font-size: 10px; padding: 8px 4px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Marriage DApp</h1>
  <p class="subtitle">On-chain marriage contracts on Sepolia testnet</p>

  <!-- Connect screen -->
  <div id="connect-screen">
    <div style="font-size:3.5rem">ğŸ’</div>
    <h2>Welcome to Marriage DApp</h2>
    <p>Formalize your union on Ethereum. Soulbound NFT rings, multisig withdrawals, and a timelock for shared savings.</p>
    <button class="btn-orange btn-lg" onclick="connectWallet()">Connect MetaMask</button>
    <button class="theme-toggle" onclick="toggleTheme()" style="margin-top:8px;">ğŸŒ™ Dark mode</button>
    <div id="connect-status" class="status"></div>
  </div>

  <!-- Main app -->
  <div id="app">

    <div id="top-bar">
      <div class="account-info">
        <div class="dot"></div>
        <span class="address" id="account-display"></span>
      </div>
      <div class="top-bar-right">
        <span class="network-badge">Sepolia</span>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
        <button class="btn-ghost btn-sm" onclick="disconnect()">Disconnect</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('tab-union')">Your Union</button>
      <button class="tab" onclick="switchTab('tab-create')">New Marriage</button>
      <button class="tab" onclick="switchTab('tab-registry')">Registry</button>
    </div>

    <!-- TAB: YOUR UNION -->
    <div id="tab-union" class="tab-content active">

      <div id="no-marriage" class="card" style="text-align:center; color:var(--muted); padding:48px 24px;">
        <div style="font-size:2.5rem; margin-bottom:12px">ğŸ”</div>
        <p style="font-size:15px; margin-bottom:8px;">No active marriage found for your address.</p>
        <p style="font-size:13px;">Switch to <strong>New Marriage</strong> to create one.</p>
      </div>

      <div id="dashboard-section">

        <div class="card">
          <h2>ğŸ“„ Marriage Contract</h2>
          <div class="info-row">
            <span class="info-label">Contract Address</span>
            <span class="info-value" id="d-address"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Partner 1</span>
            <span class="info-value" id="d-p1"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Partner 2</span>
            <span class="info-value" id="d-p2"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Names</span>
            <span class="info-value" id="d-names"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Status</span>
            <span class="info-value" id="d-status"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Timelock Duration</span>
            <span class="info-value" id="d-timelock"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Created</span>
            <span class="info-value" id="d-created"></span>
          </div>
        </div>

        <div id="nft-section" class="card">
          <h2>ğŸ’ Soulbound Ring NFT</h2>
          <div class="nft-inner">
            <img id="nft-img" class="nft-img" src="" alt="Ring" />
            <div class="nft-meta">
              <span class="badge badge-soul">Soulbound</span>
              <span class="badge badge-ring">ERC-721</span>
              <h3 id="nft-name" style="margin-top:6px;"></h3>
              <div class="info-row">
                <span class="info-label">Token ID</span>
                <span class="info-value" id="nft-id"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Union Date</span>
                <span class="info-value" id="nft-date"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Held by</span>
                <span class="info-value" style="font-size:11px" id="nft-owner"></span>
              </div>
              <p id="nft-desc" style="color:var(--muted); font-size:12px; margin-top:10px; line-height:1.5;"></p>
            </div>
          </div>
        </div>

        <div id="withdrawal-section">

          <div class="card">
            <h2>ğŸ’° Contract Balance</h2>
            <div class="balance-display"><span id="d-balance">0</span> ETH</div>
            <div style="display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; align-items:flex-end;">
              <div style="flex:1; min-width:160px;">
                <label>Deposit Amount (ETH)</label>
                <input id="dep-amount" type="number" step="0.001"
                       placeholder="0.01" style="margin-bottom:0;" />
              </div>
              <button class="btn-green" style="margin-bottom:0; height:42px;"
                      onclick="depositEth()">Deposit ETH</button>
            </div>
            <div id="deposit-status" class="status"></div>
          </div>

          <div class="card">
            <h2>ğŸ¦ Multisig Withdrawal</h2>
            <div class="steps">
              <div class="step" id="step1">1 Propose</div>
              <div class="step" id="step2">2 Approve</div>
              <div class="step" id="step3">3 Timelock</div>
              <div class="step" id="step4">4 Execute</div>
            </div>

            <div id="propose-form">
              <label>Amount (ETH)</label>
              <input id="w-amount" type="number" step="0.001" placeholder="0.01" />
              <p class="hint">
                Contract holds: <strong id="w-max-val">0</strong> ETH
                <a href="#" onclick="useMaxBalance(event)">Use max</a>
              </p>
              <label>Destination Address</label>
              <input id="w-dest" type="text" placeholder="0x..." />
              <p class="hint">Any valid non-zero address. Can be your own wallet.</p>
              <button class="btn-primary" onclick="proposeWithdrawal()">Propose Withdrawal</button>
            </div>

            <div id="pending-request" style="display:none;">
              <div class="info-row">
                <span class="info-label">Amount</span>
                <span class="info-value" id="pr-amount"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Destination</span>
                <span class="info-value" id="pr-dest"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Proposed by</span>
                <span class="info-value" id="pr-proposer"></span>
              </div>
              <div class="info-row">
                <span class="info-label">Status</span>
                <span class="info-value" id="pr-status"></span>
              </div>
              <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
                <button id="approve-btn" class="btn-blue"
                        onclick="approveWithdrawal()" style="display:none;">
                  Approve Withdrawal
                </button>
              </div>

              <div id="timelock-section" style="display:none; margin-top:20px; text-align:center;">
                <p id="timelock-label" style="color:var(--muted); font-size:13px; margin-bottom:6px;">
                  Time until execution unlocks
                </p>
                <div class="countdown" id="timelock-display">--:--:--</div>
                <button id="execute-btn" class="btn-ghost btn-lg"
                        onclick="executeWithdrawal()" style="margin-top:14px; display:none;" disabled>
                  Locked
                </button>
              </div>
            </div>

            <div id="withdrawal-status" class="status"></div>
          </div>

          <div class="card">
            <h2>Warning</h2>
            <div class="danger-zone">
              <h3>File for Divorce</h3>
              <p>
                Divorce is a permanent on-chain action. It sets isMarried to false on this contract.
                Funds and pending withdrawals are not affected. After divorce, both partners are
                free to remarry anyone by creating a new marriage contract.
              </p>
              <button class="btn-red" onclick="confirmDivorce()">File for Divorce</button>
              <div id="divorce-status" class="status"></div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- TAB: NEW MARRIAGE -->
    <div id="tab-create" class="tab-content">
      <div class="card">
        <h2>Create a New Marriage</h2>
        <label>Your Name</label>
        <input id="name1" type="text" placeholder="Alice" />
        <label>Partner Name</label>
        <input id="name2" type="text" placeholder="Bob" />
        <label>Partner Wallet Address</label>
        <input id="partner2" type="text" placeholder="0x..." />
        <p class="hint">Must be a different Ethereum address from yours.</p>
        <label>Initial Deposit (ETH) optional</label>
        <input id="deposit" type="number" value="0" step="0.001" />
        <p class="hint">ETH sent here is forwarded directly into the shared contract.</p>
        <button class="btn-primary btn-lg" onclick="createMarriage()">Create Marriage</button>
        <div id="create-status" class="status"></div>
      </div>

      <div class="card">
        <h2>How it works</h2>
        <div class="info-row">
          <span class="info-label">Deploy</span>
          <span class="info-value">Factory deploys a dedicated MarriageContract for your couple</span>
        </div>
        <div class="info-row">
          <span class="info-label">NFT</span>
          <span class="info-value">A soulbound ERC-721 ring is minted to the contract address</span>
        </div>
        <div class="info-row">
          <span class="info-label">Deposit</span>
          <span class="info-value">Both partners can deposit ETH at any time</span>
        </div>
        <div class="info-row">
          <span class="info-label">Withdraw</span>
          <span class="info-value">Propose, partner approves, timelock expires, then execute</span>
        </div>
        <div class="info-row">
          <span class="info-label">Soulbound</span>
          <span class="info-value">The NFT is locked to the contract forever</span>
        </div>
        <div class="info-row">
          <span class="info-label">Divorce</span>
          <span class="info-value">Either partner can divorce, freeing both to remarry anyone</span>
        </div>
      </div>
    </div>

    <!-- TAB: REGISTRY -->
    <div id="tab-registry" class="tab-content">
      <div class="card">
        <h2>Marriage Registry</h2>
        <div class="registry-filter">
          <button class="filter-btn active" id="filter-all"
                  onclick="setFilter('all')">All Marriages</button>
          <button class="filter-btn" id="filter-mine"
                  onclick="setFilter('mine')">My Marriages</button>
        </div>
        <button class="btn-primary btn-sm" onclick="loadRegistry()"
                style="margin-bottom:16px;">Load / Refresh</button>
        <div id="registry-list">
          <p style="color:var(--muted); font-size:13px;">
            Click Load / Refresh to fetch marriages from the chain.
          </p>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // â”€â”€ state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let provider, signer, account;
  let factoryContract, marriageContract;
  let factoryABI, marriageABI, nftABI, factoryAddress;
  let currentMarriageAddress = null;
  let timelockInterval       = null;
  let liveBalance            = 0;
  let timelockDuration       = 48 * 3600; // fallback until fetched from contract
  let registryFilter         = "all";
  let allMarriages           = [];
  let marriageStatusCache = {};


  // â”€â”€ format seconds into human readable string â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // used in status messages so they always reflect the real on-chain value
  function formatDuration(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0 && m === 0 && s === 0) return h + "h";
    if (h > 0 && m > 0  && s === 0) return h + "h " + m + "m";
    if (h > 0)                       return h + "h " + m + "m " + s + "s";
    if (m > 0 && s === 0)            return m + " minutes";
    if (m > 0)                       return m + "m " + s + "s";
    return s + " seconds";
  }

  // â”€â”€ theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleTheme() {
    const html   = document.documentElement;
    const isDark = html.getAttribute("data-theme") === "dark";
    html.setAttribute("data-theme", isDark ? "light" : "dark");
    document.querySelectorAll(".theme-toggle").forEach(btn => {
      btn.textContent = isDark ? "ğŸŒ™ Dark mode" : "â˜€ï¸ Light mode";
    });
    localStorage.setItem("theme", isDark ? "light" : "dark");
  }
  (function initTheme() {
    const saved = localStorage.getItem("theme") || "light";
    document.documentElement.setAttribute("data-theme", saved);
    document.querySelectorAll(".theme-toggle").forEach(btn => {
      btn.textContent = saved === "dark" ? "â˜€ï¸ Light mode" : "ğŸŒ™ Dark mode";
    });
  })();

  // â”€â”€ tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchTab(id) {
    document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    const idx = ["tab-union","tab-create","tab-registry"].indexOf(id);
    document.querySelectorAll(".tab")[idx].classList.add("active");
  }

  // â”€â”€ MetaMask detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getMetaMaskProvider() {
    return new Promise((resolve, reject) => {
      if (window.ethereum) {
        const eth = pickMetaMask(window.ethereum);
        if (eth) return resolve(eth);
      }
      let tries = 0;
      const iv = setInterval(() => {
        tries++;
        if (window.ethereum) {
          const eth = pickMetaMask(window.ethereum);
          if (eth) { clearInterval(iv); return resolve(eth); }
        }
        if (tries > 20) {
          clearInterval(iv);
          reject(new Error("MetaMask not found. Please install or unlock it."));
        }
      }, 100);
    });
  }
  function pickMetaMask(eth) {
    if (eth.providers?.length) return eth.providers.find(p => p.isMetaMask) ?? null;
    if (eth.isMetaMask) return eth;
    return null;
  }

  // â”€â”€ error decoding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function parseError(err) {
    const msg  = err?.message || "";
    const data = err?.data ?? err?.error?.data ?? err?.info?.error?.data ?? "";

    if (typeof data === "string" && data.startsWith("0x") && data.length >= 10) {
      const sel  = data.slice(0, 10).toLowerCase();
      const args = data.slice(10);
      switch (sel) {
        case "0x7c83fcf0": {
          const req = BigInt("0x" + args.slice(0,  64));
          const avl = BigInt("0x" + args.slice(64, 128));
          return "Amount too high. Requested " + ethers.formatEther(req) + " ETH but contract only holds " + ethers.formatEther(avl) + " ETH.";
        }
        case "0x8eaba6f9": {
          const addr = "0x" + args.slice(24, 64);
          if (addr.toLowerCase() === "0x0000000000000000000000000000000000000000")
            return "Destination cannot be the zero address.";
          return "Invalid destination address: " + addr;
        }
        case "0xe6c4247b":
          return "One of the partner addresses is invalid (zero address not allowed).";
        case "0xb2d15c0a": {
          const addr = "0x" + args.slice(24, 64);
          return addr.slice(0,10) + "... is already in an active marriage. Divorce must happen first.";
        }
        case "0x9c0a7b9e":
          return "You cannot approve your own withdrawal request. The other partner must approve it.";
        case "0x7eb6b3a0": {
          const secs = Number(BigInt("0x" + args.slice(0, 64)));
          return "Timelock still active. Wait " + formatDuration(secs) + " before executing.";
        }
        case "0x4f77de4b": {
          const avl = BigInt("0x" + args.slice(0,  64));
          const req = BigInt("0x" + args.slice(64, 128));
          return "Insufficient balance. Contract has " + ethers.formatEther(avl) + " ETH but " + ethers.formatEther(req) + " ETH is needed.";
        }
        case "0xb7328a2f":
          return "You are not a registered partner of this marriage contract.";
        case "0xccea9e6f":
          return "The caller must be one of the two partners to create this marriage.";
        case "0x05b8a8b9":
          return "A withdrawal request is already pending. Wait for it to complete before proposing a new one.";
        case "0x1f6a65b6":
          return "No pending withdrawal request to approve.";
        case "0x9a67c1cb":
          return "This withdrawal has already been executed.";
        case "0x9a5f67e8":
          return "This request has already been approved by the other partner.";
        case "0x8be9d12e":
          return "The withdrawal has not been approved yet. The other partner must approve it first.";
        case "0x90b8ec18":
          return "ETH transfer failed. The destination may have rejected it.";
        case "0xd0d4f9f1":
          return "This NFT is soulbound. Transfers and approvals are permanently disabled.";
        case "0x5b632321":
          return "Only the factory contract can call this function.";
        case "0xa0f0a7d4":
          return "This marriage is already divorced. Both partners are free to remarry.";
      }
    }

    if (msg.includes("user rejected") || msg.includes("ACTION_REJECTED"))
      return "Transaction rejected by user.";
    if (msg.includes("insufficient funds"))
      return "Not enough ETH in your wallet to cover this transaction and gas fees.";
    if (msg.includes("AlreadyDivorced"))   return "This marriage is already divorced.";
    if (msg.includes("NotAPartner"))       return "You are not a registered partner.";
    if (msg.includes("RequestPending"))    return "A withdrawal request is already pending.";
    if (msg.includes("InvalidAmount"))     return "Invalid amount. Check the contract balance.";
    if (msg.includes("InvalidDestination"))return "Invalid destination address.";
    if (msg.includes("NothingToApprove"))  return "Nothing to approve.";
    if (msg.includes("AlreadyExecuted"))   return "Already executed.";
    if (msg.includes("AlreadyApproved"))   return "Already approved.";
    if (msg.includes("CannotApproveSelf")) return "You cannot approve your own request.";
    if (msg.includes("NotApproved"))       return "Not approved yet. Partner must approve first.";
    if (msg.includes("TimelockActive"))    return "Timelock active. Wait " + formatDuration(timelockDuration) + " from proposal time before executing.";
    if (msg.includes("InsufficientBalance")) return "Insufficient contract balance.";
    if (msg.includes("TransferFailed"))    return "ETH transfer failed.";
    if (msg.includes("AlreadyMarried"))    return "One of the partners is already married.";
    if (msg.includes("Soulbound"))         return "NFT is soulbound.";
    return msg || "Unknown error occurred.";
  }

  // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(id, msg, ok) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className = "status " + (ok ? "ok" : "err");
  }

  // â”€â”€ validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function validateCreateMarriage(name1, name2, p2, deposit) {
    if (!name1.trim())         return "Your name cannot be empty.";
    if (!name2.trim())         return "Partner name cannot be empty.";
    if (!ethers.isAddress(p2)) return "Partner address is not a valid Ethereum address.";
    if (p2.toLowerCase() === "0x0000000000000000000000000000000000000000")
                               return "Partner address cannot be the zero address.";
    if (p2.toLowerCase() === account.toLowerCase())
                               return "Partner address must differ from your own address.";
    if (isNaN(parseFloat(deposit)) || parseFloat(deposit) < 0)
                               return "Deposit must be 0 or a positive number.";
    return null;
  }
  function validateWithdrawal(amount, dest) {
    if (!amount || parseFloat(amount) <= 0)
      return "Amount must be greater than 0.";
    if (parseFloat(amount) > liveBalance)
      return "Amount exceeds contract balance (" + liveBalance + " ETH). Deposit more or lower the amount.";
    if (!ethers.isAddress(dest))
      return "Destination is not a valid Ethereum address.";
    if (dest.toLowerCase() === "0x0000000000000000000000000000000000000000")
      return "Destination cannot be the zero address.";
    return null;
  }
  function validateDeposit(amount) {
    if (!amount || parseFloat(amount) <= 0) return "Deposit must be greater than 0.";
    return null;
  }

  // â”€â”€ load ABIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadAbis() {
    const res  = await fetch("/api/abis");
    const data = await res.json();
    factoryABI = data.factory; marriageABI = data.marriage;
    nftABI = data.nft; factoryAddress = data.factoryAddress;
  }

  // â”€â”€ connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function connectWallet() {
    try {
      await loadAbis();
      const ethereum = await getMetaMaskProvider();
      await ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.BrowserProvider(ethereum);
      signer   = await provider.getSigner();
      account  = await signer.getAddress();

      const network = await provider.getNetwork();
      if (network.chainId !== 11155111n) {
        try {
          await ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0xaa36a7" }],
          });
          provider = new ethers.BrowserProvider(ethereum);
          signer   = await provider.getSigner();
          account  = await signer.getAddress();
        } catch {
          setStatus("connect-status", "Please switch MetaMask to the Sepolia testnet.", false);
          return;
        }
      }

      factoryContract = new ethers.Contract(factoryAddress, factoryABI, signer);
      document.getElementById("connect-screen").style.display = "none";
      document.getElementById("app").style.display            = "block";
      document.getElementById("top-bar").style.display        = "flex";
      document.getElementById("account-display").textContent  = account;
      await loadDashboard();
    } catch (err) {
      setStatus("connect-status", parseError(err), false);
      console.error(err);
    }
  }

  // â”€â”€ disconnect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function disconnect() {
    provider = null; signer = null; account = null;
    factoryContract = null; marriageContract = null;
    currentMarriageAddress = null; liveBalance = 0;
    timelockDuration = 48 * 3600;
    if (timelockInterval) clearInterval(timelockInterval);
    document.getElementById("app").style.display            = "none";
    document.getElementById("top-bar").style.display        = "none";
    document.getElementById("connect-screen").style.display = "flex";
    document.getElementById("connect-status").className     = "status";
    document.getElementById("connect-status").textContent   = "";
  }

  // â”€â”€ load dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDashboard() {
    try {
      const indices = await factoryContract.getMarriagesByPartner(account);
      if (indices.length === 0) {
        document.getElementById("no-marriage").style.display       = "block";
        document.getElementById("dashboard-section").style.display = "none";
        return;
      }
      document.getElementById("no-marriage").style.display       = "none";
      document.getElementById("dashboard-section").style.display = "block";

      const last   = indices[indices.length - 1];
      const record = await factoryContract.marriages(last);
      currentMarriageAddress = record.contractAddress;
      marriageContract = new ethers.Contract(currentMarriageAddress, marriageABI, signer);

      document.getElementById("d-address").textContent = currentMarriageAddress;
      document.getElementById("d-names").textContent   = record.name1 + " and " + record.name2;
      document.getElementById("d-created").textContent =
        new Date(Number(record.createdAt) * 1000).toLocaleString();

      const nftAddress = await factoryContract.nftContract();
      const nft        = new ethers.Contract(nftAddress, nftABI, signer);
      const uri        = await nft.tokenURI(record.nftTokenId);
      const base64     = uri.replace("data:application/json;base64,", "");
      const metadata   = JSON.parse(atob(base64));
      showNFT(record.nftTokenId.toString(), metadata, currentMarriageAddress);
      await refreshContract();
    } catch (e) {
      console.error("loadDashboard:", e);
    }
  }

  function showNFT(tokenId, meta, ownerAddr) {
    document.getElementById("nft-section").style.display = "block";
    document.getElementById("nft-id").textContent        = "#" + tokenId;
    document.getElementById("nft-name").textContent      = meta.name        || "";
    document.getElementById("nft-desc").textContent      = meta.description || "";
    document.getElementById("nft-owner").textContent     = ownerAddr;
    const dateAttr = meta.attributes?.find(a => a.trait_type === "Union Date");
    document.getElementById("nft-date").textContent = dateAttr
      ? new Date(parseInt(dateAttr.value) * 1000).toLocaleDateString() : "Unknown";
    if (meta.image) document.getElementById("nft-img").src = meta.image;
  }

  // â”€â”€ refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function refreshContract() {
    if (!marriageContract) return;
    try {
      const [p1, p2, balWei, pending, isMarried, timelock] = await Promise.all([
        marriageContract.partner1(),
        marriageContract.partner2(),
        provider.getBalance(currentMarriageAddress),
        marriageContract.pendingRequest(),
        marriageContract.isMarried(),
        marriageContract.TIMELOCK(),
      ]);

      // store real on-chain timelock duration for use everywhere in the UI
      timelockDuration = Number(timelock);

      liveBalance = parseFloat(ethers.formatEther(balWei));
      document.getElementById("d-p1").textContent       = p1;
      document.getElementById("d-p2").textContent       = p2;
      document.getElementById("d-balance").textContent  = liveBalance;
      document.getElementById("w-max-val").textContent  = liveBalance;
      document.getElementById("d-status").textContent   = isMarried ? "Active" : "Divorced";
      document.getElementById("d-timelock").textContent = formatDuration(timelockDuration);
      document.getElementById("withdrawal-section").style.display = "block";

      renderWithdrawal(p1, p2, pending);
    } catch (e) {
      console.error("refreshContract:", e);
    }
  }

  // â”€â”€ render withdrawal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderWithdrawal(p1, p2, req) {
    const hasPending = req.amount.toString() !== "0" && !req.executed;
    document.getElementById("propose-form").style.display    = hasPending ? "none"  : "block";
    document.getElementById("pending-request").style.display = hasPending ? "block" : "none";

    if (!hasPending) {
      setStep(1,"active"); setStep(2,""); setStep(3,""); setStep(4,"");
      if (timelockInterval) clearInterval(timelockInterval);
      return;
    }

    document.getElementById("pr-amount").textContent   = ethers.formatEther(req.amount) + " ETH";
    document.getElementById("pr-dest").textContent     = req.destination;
    document.getElementById("pr-proposer").textContent = req.proposer;

    const isPartner  = account.toLowerCase() === p1.toLowerCase() ||
                       account.toLowerCase() === p2.toLowerCase();
    const isProposer = account.toLowerCase() === req.proposer.toLowerCase();

    if (!req.approvedByOther) {
      setStep(1,"done"); setStep(2,"waiting"); setStep(3,""); setStep(4,"");
      document.getElementById("pr-status").textContent = isProposer
        ? "Waiting for your partner to approve."
        : "Your partner proposed this withdrawal. Review and approve below.";
      document.getElementById("approve-btn").style.display =
        isPartner && !isProposer ? "inline-block" : "none";
      document.getElementById("timelock-section").style.display = "block";
      document.getElementById("execute-btn").style.display      = "none";
      startCountdown(Number(req.requestedAt), false);
    } else {
      setStep(1,"done"); setStep(2,"done"); setStep(3,"active"); setStep(4,"");
      document.getElementById("pr-status").textContent =
        "Approved. Timelock of " + formatDuration(timelockDuration) + " is running.";
      document.getElementById("approve-btn").style.display      = "none";
      document.getElementById("timelock-section").style.display = "block";
      document.getElementById("execute-btn").style.display      = "block";
      startCountdown(Number(req.requestedAt), true);
    }
  }

  function setStep(n, state) {
    const el = document.getElementById("step" + n);
    el.className = "step" + (state ? " " + state : "");
  }

  // â”€â”€ countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startCountdown(requestedAt, canExecute) {
    if (timelockInterval) clearInterval(timelockInterval);
    const label = document.getElementById("timelock-display");
    const lbl   = document.getElementById("timelock-label");
    const btn   = document.getElementById("execute-btn");

    timelockInterval = setInterval(() => {
      const left = (requestedAt + timelockDuration) - Math.floor(Date.now() / 1000);

      if (left <= 0) {
        label.textContent = "READY";
        label.className   = "countdown ready";
        if (canExecute) {
          lbl.textContent = "Timelock expired. Ready to execute.";
          btn.textContent = "Execute Withdrawal";
          btn.className   = "btn-green btn-lg";
          btn.disabled    = false;
          setStep(3,"done"); setStep(4,"active");
        } else {
          lbl.textContent =
            "Timelock of " + formatDuration(timelockDuration) +
            " already expired. Waiting for partner approval.";
        }
        clearInterval(timelockInterval);
      } else {
        const h = String(Math.floor(left / 3600)).padStart(2,"0");
        const m = String(Math.floor((left % 3600) / 60)).padStart(2,"0");
        const s = String(left % 60).padStart(2,"0");
        label.textContent = h + ":" + m + ":" + s;
        label.className   = "countdown";
        if (canExecute) {
          lbl.textContent =
            "Time remaining before execution unlocks (" +
            formatDuration(timelockDuration) + " total)";
          btn.textContent = "Locked";
          btn.className   = "btn-ghost btn-lg";
          btn.disabled    = true;
        } else {
          lbl.textContent =
            "Timelock running since proposal (" +
            formatDuration(timelockDuration) + " total). Waiting for partner approval.";
        }
      }
    }, 1000);
  }

  function useMaxBalance(e) {
    e.preventDefault();
    document.getElementById("w-amount").value = liveBalance;
  }

  // â”€â”€ deposit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function depositEth() {
    const amount = document.getElementById("dep-amount").value;
    const err = validateDeposit(amount);
    if (err) { setStatus("deposit-status", err, false); return; }
    setStatus("deposit-status", "Sending deposit...", true);
    try {
      const tx = await signer.sendTransaction({
        to: currentMarriageAddress, value: ethers.parseEther(amount),
      });
      await tx.wait();
      setStatus("deposit-status", "Successfully deposited " + amount + " ETH.", true);
      document.getElementById("dep-amount").value = "";
      await refreshContract();
    } catch (err) {
      setStatus("deposit-status", parseError(err), false);
    }
  }

  // â”€â”€ create marriage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function createMarriage() {
    const name1    = document.getElementById("name1").value;
    const name2    = document.getElementById("name2").value;
    const partner2 = document.getElementById("partner2").value;
    const deposit  = document.getElementById("deposit").value || "0";
    const err = validateCreateMarriage(name1, name2, partner2, deposit);
    if (err) { setStatus("create-status", err, false); return; }
    setStatus("create-status", "Deploying marriage contract...", true);
    try {
      const tx      = await factoryContract.createMarriage(
        name1, name2, account, partner2, { value: ethers.parseEther(deposit) }
      );
      const receipt = await tx.wait();
      const event   = receipt.logs
        .map(log => { try { return factoryContract.interface.parseLog(log); } catch { return null; } })
        .find(e => e?.name === "MarriageCreated");
      currentMarriageAddress = event.args.contractAddress;
      marriageContract = new ethers.Contract(currentMarriageAddress, marriageABI, signer);
      setStatus("create-status", "Marriage created at " + currentMarriageAddress, true);
      switchTab("tab-union");
      await loadDashboard();
    } catch (err) {
      setStatus("create-status", parseError(err), false);
      console.error(err);
    }
  }

  // â”€â”€ propose â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function proposeWithdrawal() {
    const amount = document.getElementById("w-amount").value;
    const dest   = document.getElementById("w-dest").value;
    const err = validateWithdrawal(amount, dest);
    if (err) { setStatus("withdrawal-status", err, false); return; }
    setStatus("withdrawal-status", "Submitting proposal...", true);
    try {
      const tx = await marriageContract.proposeWithdrawal(ethers.parseEther(amount), dest);
      await tx.wait();
      setStatus("withdrawal-status",
        "Proposal submitted. Your partner must now approve it. " +
        "Once approved, a timelock of " + formatDuration(timelockDuration) + " will begin.", true);
      document.getElementById("w-amount").value = "";
      document.getElementById("w-dest").value   = "";
      await refreshContract();
    } catch (err) {
      setStatus("withdrawal-status", parseError(err), false);
      console.error(err);
    }
  }

  // â”€â”€ approve â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function approveWithdrawal() {
    setStatus("withdrawal-status", "Approving...", true);
    try {
      const tx = await marriageContract.approveWithdrawal();
      await tx.wait();
      setStatus("withdrawal-status",
        "Approved. Timelock of " + formatDuration(timelockDuration) + " has started.", true);
      await refreshContract();
    } catch (err) {
      setStatus("withdrawal-status", parseError(err), false);
      console.error(err);
    }
  }

  // â”€â”€ execute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function executeWithdrawal() {
    setStatus("withdrawal-status", "Executing withdrawal...", true);
    try {
      const tx = await marriageContract.executeWithdrawal();
      await tx.wait();
      setStatus("withdrawal-status", "Withdrawal executed. Funds sent successfully.", true);
      await refreshContract();
    } catch (err) {
      setStatus("withdrawal-status", parseError(err), false);
      console.error(err);
    }
  }

  // â”€â”€ divorce â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function confirmDivorce() {
    const confirmed = window.confirm(
      "Are you sure you want to file for divorce?\n\n" +
      "This sets isMarried to false permanently on-chain.\n" +
      "This action cannot be undone.\n\n" +
      "Funds and pending withdrawals are not affected.\n" +
      "Both partners will be free to remarry after divorce."
    );
    if (confirmed) divorce();
  }

  async function divorce() {
    setStatus("divorce-status", "Filing for divorce...", true);
    try {
      const tx = await marriageContract.divorce();
      await tx.wait();
      setStatus("divorce-status",
        "Divorce recorded on-chain. Both partners are now free to remarry.", true);
      await refreshContract();
    } catch (err) {
      setStatus("divorce-status", parseError(err), false);
      console.error(err);
    }
  }

  // â”€â”€ registry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setFilter(f) {
    registryFilter = f;
    document.getElementById("filter-all").classList.toggle("active",  f === "all");
    document.getElementById("filter-mine").classList.toggle("active", f === "mine");
    renderRegistry();
  }

  async function loadRegistry() {
  const list = document.getElementById("registry-list");
  list.innerHTML = "<p style='color:var(--muted); font-size:13px;'>Loading from chain...</p>";
  try {
    allMarriages = await factoryContract.getAllMarriages();
    list.innerHTML = "<p style='color:var(--muted); font-size:13px;'>Fetching live status...</p>";
    marriageStatusCache = {};
    await Promise.all(allMarriages.map(async (m) => {
      try {
        const mc = new ethers.Contract(
          m.contractAddress,
          ["function isMarried() view returns (bool)"],
          provider
        );
        marriageStatusCache[m.contractAddress.toLowerCase()] = await mc.isMarried();
      } catch (e) {
        console.warn("status fetch failed for", m.contractAddress, e);
        marriageStatusCache[m.contractAddress.toLowerCase()] = null;
      }
    }));
    renderRegistry();
  } catch (e) {
    list.innerHTML = "<div class='status err' style='display:block;'>" + parseError(e) + "</div>";
  }
}


function renderRegistry() {
  const list = document.getElementById("registry-list");
  if (allMarriages.length === 0) {
    list.innerHTML = "<p style='color:var(--muted); font-size:13px;'>No marriages on record yet.</p>";
    return;
  }
  const filtered = registryFilter === "mine"
    ? allMarriages.filter(m =>
        m.partner1.toLowerCase() === account?.toLowerCase() ||
        m.partner2.toLowerCase() === account?.toLowerCase()
      )
    : allMarriages;

  if (filtered.length === 0) {
    list.innerHTML = "<p style='color:var(--muted); font-size:13px;'>No marriages found for your address.</p>";
    return;
  }
  list.innerHTML = "";
  filtered.forEach((m, i) => {
    const isMine = m.partner1.toLowerCase() === account?.toLowerCase() ||
                   m.partner2.toLowerCase() === account?.toLowerCase();
    const date         = new Date(Number(m.createdAt) * 1000).toLocaleDateString();
    const isMarried    = marriageStatusCache[m.contractAddress.toLowerCase()];
    const statusLabel  = isMarried === true ? "Active" : isMarried === false ? "Divorced" : "Unknown";
    const statusBg     = isMarried === true ? "var(--ok-bg)"   : "var(--err-bg)";
    const statusColor  = isMarried === true ? "var(--ok-text)" : "var(--err-text)";
    const borderColor  = isMarried === false ? "var(--red)" : isMine ? "var(--primary)" : "var(--border)";

    const div = document.createElement("div");
    div.className = "marriage-item" + (isMine ? " mine" : "");
    div.style.borderColor = borderColor;
    if (isMarried === false) div.style.opacity = "0.75";

    div.innerHTML =
      '<div class="names">' +
        "#" + i + " " + m.name1 + " and " + m.name2 +
        (isMine ? '<span class="mine-badge">YOURS</span>' : "") +
        '<span style="display:inline-block; font-size:10px; font-weight:700; padding:2px 8px; border-radius:20px; margin-left:6px; vertical-align:middle; background:' + statusBg + '; color:' + statusColor + ';">' + statusLabel + '</span>' +
      "</div>" +
      '<div class="addr">Contract: ' + m.contractAddress + "</div>" +
      '<div class="addr">Partner 1: ' + m.partner1 + "</div>" +
      '<div class="addr">Partner 2: ' + m.partner2 + "</div>" +
      '<div style="margin-top:8px; font-size:12px; color:var(--muted); display:flex; gap:16px; flex-wrap:wrap;">' +
        "<span>Created: " + date + "</span>" +
        "<span>NFT #" + m.nftTokenId + "</span>" +
      "</div>";
    list.appendChild(div);
  });
}


  // â”€â”€ account / chain changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.ethereum?.on("accountsChanged", () => location.reload());
  window.ethereum?.on("chainChanged",    () => location.reload());
</script>
</body>
</html>
